# ClickHouse TypeScript Type Generator

A fast, safe, and extensible CLI tool that parses ClickHouse `CREATE TABLE` statements and generates clean, type-safe TypeScript interfaces with optional Zod schemas and JSON Schema definitions.

## Features

- **üéØ Type-Safe**: Generates accurate TypeScript interfaces from ClickHouse DDL
- **‚ö° Fast**: Built with performance in mind using Chevrotain parser
- **üîí Safe**: Tiger Style philosophy with explicit bounds and comprehensive validation
- **üß© Extensible**: Modular architecture for easy feature additions
- **üì¶ Multiple Outputs**: TypeScript interfaces, Zod schemas, JSON Schema
- **üé® Customizable**: Configurable type mappings and naming conventions
- **üõ°Ô∏è Robust**: Comprehensive error handling and recovery

## Installation

```bash
npm install -g @ch2ts/cli
# or
pnpm add -g @ch2ts/cli
# or
yarn global add @ch2ts/cli
```

## Quick Start

### Basic Usage

```bash
# Generate TypeScript from DDL file
ch2ts schema.sql --output types.ts

# Generate with Zod schemas
ch2ts schema.sql --output types.ts --emit-zod

# Generate JSON Schema
ch2ts schema.sql --output-json-schema schema.json

# Read from stdin
cat schema.sql | ch2ts --output types.ts
```

## CLI Options

```
Usage: ch2ts [options] <input-file>

Generate TypeScript types from ClickHouse CREATE TABLE statements

Arguments:
  input-file                    ClickHouse DDL file to process (use - for stdin)

Options:
  -o, --output <file>          Output TypeScript file path
  --output-json-schema <file>  Output JSON Schema file path
  --emit-zod                   Generate Zod schemas alongside TypeScript interfaces
  --camel                      Convert column names to camelCase
  --int64-as <type>           How to handle Int64/UInt64 types (choices: "bigint", "string", default: "bigint")
  --decimal-as <type>         How to handle Decimal types (choices: "string", "Decimal", default: "string")  
  --datetime-as <type>        How to handle DateTime types (choices: "string", "Date", default: "string")
  -h, --help                  Display help for command
  -V, --version               Display version number
```

## Input/Output Examples

### Example 1: Basic Table

**Input DDL:**
```sql
CREATE TABLE users (
    id UInt64,
    name String,
    email String,
    age UInt8,
    created_at DateTime
) ENGINE = MergeTree()
ORDER BY id;
```

**Output TypeScript:**
```typescript
/*
 * Generated by @ch2ts/core
 * Options: {"emitZod":false}
 */

export interface Users {
  /** Original: UInt64 */
  id: bigint;
  /** Original: String */
  name: string;
  /** Original: String */
  email: string;
  /** Original: UInt8 */
  age: number;
  /** Original: DateTime */
  created_at: string;
}
```

### Example 2: Complex Types with Zod

**Input DDL:**
```sql
CREATE TABLE products (
    id UInt64,
    name String,
    price Decimal(10,2),
    tags Array(String),
    metadata Map(String, String),
    status Enum8('active' = 1, 'inactive' = 0),
    dimensions Tuple(Float64, Float64, Float64),
    description Nullable(String)
) ENGINE = MergeTree()
ORDER BY id;
```

**Generated TypeScript with Zod (`--emit-zod`):**
```typescript
/*
 * Generated by @ch2ts/core
 * Options: {"emitZod":true}
 */

import { z } from "zod";

export interface Products {
  /** Original: UInt64 */
  id: bigint;
  /** Original: String */
  name: string;
  /** Original: Decimal(10,2) */
  price: string;
  /** Original: Array(String) */
  tags: string[];
  /** Original: Map(String, String) */
  metadata: Record<string, string>;
  /** Original: Enum8('active' = 1, 'inactive' = 0) */
  status: "active" | "inactive";
  /** Original: Tuple(Float64, Float64, Float64) */
  dimensions: { _0: number; _1: number; _2: number };
  /** Original: Nullable(String) */
  description: string | null;
}

export const ProductsSchema = z.object({
  id: z.bigint(),
  name: z.string(),
  price: z.string(),
  tags: z.array(z.string()),
  metadata: z.record(z.string(), z.string()),
  status: z.enum(['active', 'inactive']),
  dimensions: z.object({ _0: z.number(), _1: z.number(), _2: z.number() }),
  description: z.string().nullable(),
});
```

### Example 3: Materialized View

**Input DDL:**
```sql
CREATE MATERIALIZED VIEW daily_stats AS
SELECT 
    toDate(created_at) as date,
    count() as total_users,
    avg(age) as avg_age
FROM users
GROUP BY toDate(created_at);
```

**Output TypeScript:**
```typescript
export interface DailyStats {
  /** Original: Unknown */
  date: unknown;
  /** Original: Unknown */
  total_users: number;
  /** Original: Unknown */
  avg_age: number;
}
```

### Example 4: JSON Schema Output

**Generated JSON Schema (`--output-json-schema`):**
```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "Users": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "Original: UInt64"
        },
        "name": {
          "type": "string",
          "description": "Original: String"
        },
        "email": {
          "type": "string", 
          "description": "Original: String"
        },
        "age": {
          "type": "number",
          "description": "Original: UInt8"
        },
        "created_at": {
          "type": "string",
          "description": "Original: DateTime"
        }
      },
      "required": ["id", "name", "email", "age", "created_at"],
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
```

## Type Mappings

### Numeric Types

| ClickHouse Type | TypeScript Default | With `--int64-as string` | With `--decimal-as Decimal` |
|-----------------|-------------------|--------------------------|----------------------------|
| `Int8`, `Int16`, `Int32` | `number` | `number` | `number` |
| `UInt8`, `UInt16`, `UInt32` | `number` | `number` | `number` |
| `Int64`, `UInt64` | `bigint` | `string` | `bigint` |
| `Float32`, `Float64` | `number` | `number` | `number` |
| `Decimal(P,S)` | `string` | `string` | `Decimal` |

### String Types

| ClickHouse Type | TypeScript |
|-----------------|------------|
| `String` | `string` |
| `FixedString(N)` | `string` |
| `UUID` | `string` |

### Date/Time Types

| ClickHouse Type | TypeScript Default | With `--datetime-as Date` |
|-----------------|-------------------|---------------------------|
| `Date` | `string` | `Date` |
| `DateTime` | `string` | `Date` |
| `DateTime64(P)` | `string` | `Date` |

### Complex Types

| ClickHouse Type | TypeScript |
|-----------------|------------|
| `Array(T)` | `T[]` |
| `Tuple(T1,T2,...)` | `{ _0: T1; _1: T2; ... }` |
| `Map(K,V)` | `Record<K,V>` |
| `Nullable(T)` | `T \| null` |
| `LowCardinality(T)` | `T` |
| `Enum8/Enum16` | `"value1" \| "value2" \| ...` |

### Special Types

| ClickHouse Type | TypeScript |
|-----------------|------------|
| `IPv4` | `IPv4` (branded string) |
| `IPv6` | `IPv6` (branded string) |

## Advanced Usage

### Multiple Files

```bash
# Process multiple DDL files
ch2ts schema1.sql schema2.sql --output combined-types.ts

# Process directory of SQL files
find ./schemas -name "*.sql" -exec cat {} \; | ch2ts --output types.ts
```

### Custom Configuration

```bash
# Generate with custom type mappings
ch2ts schema.sql \
  --output types.ts \
  --emit-zod \
  --camel \
  --int64-as string \
  --decimal-as Decimal \
  --datetime-as Date
```

### Pipeline Usage

```bash
# Use in CI/CD pipeline
curl -s https://api.example.com/schema.sql | ch2ts --output src/types.ts --emit-zod
```

## Programmatic API

```typescript
import { parse, map, emit, generateSource } from '@ch2ts/core';

// Parse DDL to AST
const tables = parse(ddl);

// Map to TypeScript types  
const mapped = map(tables, {
  camelCase: true,
  int64As: 'string',
  decimalAs: 'string',
  dateTimeAs: 'string'
});

// Emit TypeScript code
const typescript = emit(mapped, { emitZod: true });

// Or do it all in one step
const source = generateSource(ddl, mappingOptions, emissionOptions);
```

## Supported ClickHouse Features

### ‚úÖ Fully Supported
- Basic data types (integers, floats, strings, dates)
- Complex types (Array, Tuple, Map, Nullable, LowCardinality)
- Enum types (Enum8, Enum16)
- Table comments and column comments
- Default values
- Materialized views (with type inference limitations)
- Multiple table definitions

### ‚ö†Ô∏è Partial Support
- Materialized views (column types inferred as `unknown`, requires manual typing)
- Complex nested types (deeply nested structures)
- Custom functions in default values

### ‚ùå Not Supported
- Views (CREATE VIEW) - skipped during processing
- Complex table engines with parameters
- Constraints and indexes
- Custom codecs (parsed but not reflected in types)

## Error Handling

The tool includes comprehensive error handling:

- **Parse Errors**: Detailed error messages with line/column information
- **Type Mapping Errors**: Clear indication of unsupported type combinations
- **File I/O Errors**: Helpful messages for file access issues
- **Recovery**: Continues processing other tables when one fails

## Performance

- **Fast Parsing**: Chevrotain-based parser for optimal performance
- **Memory Efficient**: Bounded operations prevent memory exhaustion
- **Large Files**: Can handle DDL files up to 10MB with 1000+ tables
- **Safety Limits**: Built-in limits prevent runaway processing

## Contributing

This project follows Tiger Style philosophy:
- Safety first with explicit bounds and comprehensive validation
- Performance-oriented with predictable execution paths
- Developer experience focused with clear documentation and error messages

## License

MIT

## Changelog

See [CHANGELOG.md](./CHANGELOG.md) for version history and breaking changes.
